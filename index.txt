<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DELTA GREEN // EYES ONLY</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=DM+Sans:wght@300;400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- ═══════════════════════════════════════════════════════
     FIREBASE SDK  (compat v9 — works in a plain HTML file)
     ════════════════════════════════════════════════════ -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<!-- ═══════════════════════════════════════════════════════
     ════════════════════════════════════════════════════ -->
<script>
  const firebaseConfig = {
    apiKey:            "AIzaSyDT08zaHg7WqgPYN7j8pXEHWd4V1pcKq4o",
    authDomain:        "delta-green-email.firebaseapp.com",
    databaseURL:       "https://delta-green-email-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId:         "delta-green-email",
    storageBucket:     "delta-green-email.firebasestorage.app",
    messagingSenderId: "722006588271",
    appId:             "1:722006588271:web:01b00681340ac38e59069a"
  };
  firebase.initializeApp(firebaseConfig);
  const rtdb = firebase.database();           // shorthand used throughout the app
  const GAME_REF = rtdb.ref('deltagreen_v1'); // all game data lives at this path
</script>

<style>
:root {
  --bg-deep:    #0a0d11;
  --bg-base:    #0d1117;
  --bg-raised:  #161b22;
  --bg-panel:   #1c232d;
  --bg-hover:   #222c38;
  --border:     #2a3441;
  --border-lit: #3d5068;
  --text-primary: #c8d8e8;
  --text-muted:   #6b7f92;
  --text-dim:     #3d5068;
  --accent-green: #4ec9a0;
  --accent-amber: #d4922a;
  --accent-red:   #c0392b;
  --accent-blue:  #4a8bbf;
  --accent-teal:  #2e8b7a;
  --classified-glow: rgba(78,201,160,0.12);
  --font-mono: 'IBM Plex Mono', 'Share Tech Mono', monospace;
  --font-body: 'DM Sans', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 14px;
  overflow: hidden;
}

/* ── NOISE OVERLAY ───────────────────────────────────── */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 9999;
  pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
  opacity: 0.6;
}

/* ── SCANLINES ───────────────────────────────────────── */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 9998;
  pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.06) 2px,
    rgba(0,0,0,0.06) 4px
  );
}

/* ── SCROLLBARS ──────────────────────────────────────── */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg-base); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ════════════════════════════════════════════════════════
   FIREBASE LOADING SCREEN
   Shown while the app fetches its first snapshot from the
   cloud database.  Hidden once data arrives.
════════════════════════════════════════════════════════ */
#loading-screen {
  position: fixed; inset: 0; z-index: 2000;
  background: var(--bg-deep);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 24px;
  transition: opacity 0.5s ease;
}
#loading-screen.fade-out { opacity: 0; pointer-events: none; }
#loading-screen.hidden   { display: none; }

.loading-title {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.45em;
  color: var(--accent-green);
  text-transform: uppercase;
}
.loading-bar-wrap {
  width: 240px;
  height: 2px;
  background: var(--border);
  overflow: hidden;
  position: relative;
}
.loading-bar-fill {
  position: absolute; top: 0; left: -60%;
  width: 60%; height: 100%;
  background: var(--accent-green);
  animation: loadbar 1.2s ease-in-out infinite;
}
@keyframes loadbar {
  0%   { left: -60%; }
  100% { left: 110%; }
}
.loading-status {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.2em;
  color: var(--text-muted);
}

/* ════════════════════════════════════════════════════════
   LOGIN SCREEN
════════════════════════════════════════════════════════ */
#login-screen {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--bg-deep);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 0;
}

#login-screen.hidden { display: none; }

.login-scanline {
  position: absolute; inset: 0; pointer-events: none; overflow: hidden;
}
.login-scanline::after {
  content: '';
  position: absolute; left: 0; right: 0; height: 3px;
  background: linear-gradient(transparent, var(--accent-green), transparent);
  animation: scandown 3s linear infinite;
  opacity: 0.4;
}
@keyframes scandown {
  0% { top: -3px; }
  100% { top: 100%; }
}

.login-logo {
  font-family: var(--font-mono);
  text-align: center;
  margin-bottom: 48px;
  animation: fadein 1s ease both;
}
.login-logo .agency-name {
  font-size: 13px;
  letter-spacing: 0.5em;
  color: var(--accent-green);
  text-transform: uppercase;
  margin-bottom: 6px;
}
.login-logo .agency-slash {
  font-size: 28px;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: 0.15em;
  line-height: 1.1;
}
.login-logo .agency-sub {
  font-size: 10px;
  letter-spacing: 0.4em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-top: 8px;
}

.login-box {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  padding: 36px 40px;
  width: 360px;
  position: relative;
  animation: fadein 1.2s ease both;
}
.login-box::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent-green), transparent);
}

.login-box h2 {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.35em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 24px;
}

.login-field {
  margin-bottom: 16px;
}
.login-field label {
  display: block;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.2em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 6px;
}
.login-field input {
  width: 100%;
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  padding: 10px 12px;
  outline: none;
  transition: border-color 0.2s;
}
.login-field input:focus { border-color: var(--accent-green); }

#login-account-select {
  width: 100%;
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 10px 12px;
  outline: none;
  margin-bottom: 16px;
}

.btn-primary {
  width: 100%;
  background: transparent;
  border: 1px solid var(--accent-green);
  color: var(--accent-green);
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  padding: 11px;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}
.btn-primary:hover {
  background: var(--accent-green);
  color: var(--bg-deep);
}

.login-error {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-red);
  margin-top: 12px;
  letter-spacing: 0.1em;
  min-height: 16px;
}

.login-hint {
  margin-top: 24px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  text-align: center;
  letter-spacing: 0.15em;
}

/* ════════════════════════════════════════════════════════
   MAIN APP
════════════════════════════════════════════════════════ */
#app {
  display: none;
  flex-direction: column;
  height: 100vh;
}
#app.visible { display: flex; }

/* ── HEADER ─────────────────────────────────────────── */
#header {
  height: 52px;
  background: var(--bg-base);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 16px;
  gap: 16px;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}

.header-brand {
  font-family: var(--font-mono);
  font-size: 12px;
  letter-spacing: 0.3em;
  color: var(--accent-green);
  text-transform: uppercase;
  user-select: none;
  white-space: nowrap;
}
.header-brand span { color: var(--text-dim); }

.classification-badge {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.25em;
  color: var(--accent-red);
  border: 1px solid var(--accent-red);
  padding: 3px 8px;
  text-transform: uppercase;
  animation: pulse-badge 2s ease-in-out infinite;
}
@keyframes pulse-badge {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.header-spacer { flex: 1; }

.header-user {
  display: flex; align-items: center; gap: 10px;
}
.header-user-info {
  text-align: right;
}
.header-user-handle {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-green);
  letter-spacing: 0.05em;
}
.header-user-role {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-muted);
  letter-spacing: 0.2em;
  text-transform: uppercase;
}

.btn-icon {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 6px 10px;
  cursor: pointer;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-icon:hover {
  border-color: var(--accent-green);
  color: var(--accent-green);
}
.btn-icon.danger:hover {
  border-color: var(--accent-red);
  color: var(--accent-red);
}
.btn-icon .material-icons {
  font-size: 14px;
  vertical-align: middle;
  margin-right: 4px;
}

/* ── SYSTEM ALERT BANNER ────────────────────────────── */
#system-alert {
  background: rgba(192,57,43,0.15);
  border-bottom: 1px solid var(--accent-red);
  padding: 8px 16px;
  display: none;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  animation: alert-blink 1s ease-in-out infinite;
}
#system-alert.visible { display: flex; }
@keyframes alert-blink {
  0%, 100% { background: rgba(192,57,43,0.15); }
  50% { background: rgba(192,57,43,0.25); }
}
.alert-label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.3em;
  color: var(--accent-red);
  text-transform: uppercase;
  white-space: nowrap;
}
.alert-text {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #e8c0bc;
  flex: 1;
}
#dismiss-alert {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
  padding: 0 4px;
}

/* ── MAIN WORKSPACE ─────────────────────────────────── */
#workspace {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ── SIDEBAR ─────────────────────────────────────────── */
#sidebar {
  width: 220px;
  min-width: 220px;
  background: var(--bg-base);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  flex-shrink: 0;
}

.compose-btn {
  margin: 16px 12px 8px;
  background: transparent;
  border: 1px solid var(--accent-green);
  color: var(--accent-green);
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  padding: 10px 12px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.compose-btn:hover {
  background: rgba(78,201,160,0.08);
  box-shadow: 0 0 16px rgba(78,201,160,0.15);
}
.compose-btn .material-icons { font-size: 15px; }

.sidebar-section {
  padding: 12px 0 4px;
}
.sidebar-section-label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.35em;
  color: var(--text-dim);
  text-transform: uppercase;
  padding: 0 16px;
  margin-bottom: 4px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 16px;
  cursor: pointer;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.05em;
  transition: all 0.15s;
  border-left: 2px solid transparent;
  position: relative;
}
.sidebar-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.sidebar-item.active {
  border-left-color: var(--accent-green);
  background: rgba(78,201,160,0.06);
  color: var(--accent-green);
}
.sidebar-item .material-icons {
  font-size: 15px;
  flex-shrink: 0;
}
.sidebar-item .badge {
  margin-left: auto;
  background: var(--accent-green);
  color: var(--bg-deep);
  font-size: 9px;
  font-weight: 600;
  padding: 1px 5px;
  border-radius: 2px;
  min-width: 16px;
  text-align: center;
}
.sidebar-item .badge.amber { background: var(--accent-amber); }

.sidebar-divider {
  height: 1px;
  background: var(--border);
  margin: 8px 0;
}

/* ── EMAIL LIST PANEL ───────────────────────────────── */
#email-list-panel {
  width: 300px;
  min-width: 260px;
  background: var(--bg-raised);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

.panel-header {
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.panel-title {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.25em;
  color: var(--text-muted);
  text-transform: uppercase;
}
.panel-count {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-dim);
  margin-top: 3px;
  letter-spacing: 0.1em;
}

#email-list {
  flex: 1;
  overflow-y: auto;
}

.email-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.15s;
  animation: slide-in 0.3s ease both;
  position: relative;
}
.email-item:hover { background: var(--bg-hover); }
.email-item.active { background: var(--bg-panel); border-left: 2px solid var(--accent-green); }
.email-item.unread .email-subject { color: var(--text-primary); font-weight: 500; }
.email-item.unread::before {
  content: '';
  position: absolute; left: 6px; top: 50%; transform: translateY(-50%);
  width: 4px; height: 4px;
  background: var(--accent-green);
  border-radius: 50%;
}
.email-item.npc-source .email-sender { color: var(--accent-amber); }
.email-item.intercepted { opacity: 0.6; }

.email-sender {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-teal);
  letter-spacing: 0.05em;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: flex;
  align-items: center;
  gap: 6px;
}
.sender-badge {
  font-size: 8px;
  letter-spacing: 0.15em;
  padding: 1px 5px;
  border-radius: 1px;
  text-transform: uppercase;
  flex-shrink: 0;
}
.badge-encrypted { background: rgba(212,146,42,0.2); color: var(--accent-amber); border: 1px solid rgba(212,146,42,0.4); }
.badge-intercepted { background: rgba(192,57,43,0.2); color: var(--accent-red); border: 1px solid rgba(192,57,43,0.4); }
.badge-secure { background: rgba(78,201,160,0.1); color: var(--accent-green); border: 1px solid rgba(78,201,160,0.3); }

.email-subject {
  font-family: var(--font-body);
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.email-preview {
  font-family: var(--font-body);
  font-size: 11px;
  color: var(--text-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.email-time {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-dim);
  float: right;
  margin-top: 2px;
}

@keyframes slide-in {
  from { opacity: 0; transform: translateX(-8px); }
  to { opacity: 1; transform: translateX(0); }
}

.empty-state {
  padding: 32px 16px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 0.1em;
  line-height: 2;
}

/* ── MESSAGE DETAIL ─────────────────────────────────── */
#message-detail {
  flex: 1;
  background: var(--bg-panel);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.detail-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 12px;
}
.detail-empty .material-icons {
  font-size: 48px;
  color: var(--text-dim);
}
.detail-empty p {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 0.2em;
  text-transform: uppercase;
}

.detail-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.detail-subject {
  font-family: var(--font-mono);
  font-size: 16px;
  color: var(--text-primary);
  font-weight: 500;
  letter-spacing: 0.05em;
  margin-bottom: 12px;
}
.detail-meta {
  display: grid;
  grid-template-columns: 60px 1fr;
  gap: 4px 8px;
  font-family: var(--font-mono);
  font-size: 11px;
}
.detail-meta-label { color: var(--text-dim); letter-spacing: 0.15em; }
.detail-meta-value { color: var(--text-muted); }
.detail-meta-value.sender { color: var(--accent-teal); }
.detail-meta-value.npc-sender { color: var(--accent-amber); }

.detail-actions {
  display: flex;
  gap: 8px;
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.detail-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}
.detail-body-text {
  font-family: var(--font-body);
  font-size: 14px;
  line-height: 1.8;
  color: var(--text-primary);
  white-space: pre-wrap;
  word-break: break-word;
}

.selfdestruct-timer {
  margin: 16px 0 0;
  padding: 10px 14px;
  background: rgba(192,57,43,0.1);
  border: 1px solid rgba(192,57,43,0.4);
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-red);
  letter-spacing: 0.15em;
  display: flex;
  align-items: center;
  gap: 8px;
}
.selfdestruct-timer .material-icons { font-size: 14px; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Secure channel animation */
.secure-channel-banner {
  margin: 0 24px 16px;
  padding: 8px 14px;
  background: rgba(78,201,160,0.07);
  border: 1px solid rgba(78,201,160,0.25);
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--accent-green);
  letter-spacing: 0.25em;
  text-transform: uppercase;
  animation: channel-establish 0.8s ease both;
  display: flex;
  align-items: center;
  gap: 8px;
}
@keyframes channel-establish {
  0% { opacity: 0; width: 0; overflow: hidden; }
  60% { opacity: 1; }
  100% { opacity: 1; width: auto; }
}

/* ── REDACTED CLASS ──────────────────────────────────── */
.redacted {
  background-color: #000 !important;
  color: transparent !important;
  border-radius: 2px;
  user-select: none;
  padding: 0 2px;
}

/* ════════════════════════════════════════════════════════
   COMPOSE MODAL
════════════════════════════════════════════════════════ */
#compose-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(10,13,17,0.7);
  display: none;
  align-items: flex-end;
  justify-content: flex-end;
  padding: 16px;
}
#compose-overlay.visible { display: flex; }

#compose-window {
  width: 520px;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-bottom: none;
  display: flex;
  flex-direction: column;
  max-height: 80vh;
  position: relative;
  animation: compose-rise 0.2s ease;
  box-shadow: 0 -8px 40px rgba(0,0,0,0.5);
}
@keyframes compose-rise {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.compose-window-header {
  padding: 12px 16px;
  background: var(--bg-panel);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}
.compose-window-title {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.3em;
  color: var(--accent-green);
  text-transform: uppercase;
}
.compose-close {
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; font-size: 18px; line-height: 1;
}
.compose-close:hover { color: var(--accent-red); }

.compose-field {
  display: flex;
  align-items: flex-start;
  border-bottom: 1px solid var(--border);
  padding: 0;
}
.compose-field-label {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.2em;
  color: var(--text-dim);
  text-transform: uppercase;
  padding: 11px 12px;
  flex-shrink: 0;
  width: 70px;
}
.compose-field input, .compose-field select, .compose-field textarea {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 10px 12px;
  resize: none;
}
.compose-field select option { background: var(--bg-raised); }

.compose-body {
  flex: 1;
  padding: 0;
  min-height: 180px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.compose-body textarea {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 13px;
  padding: 14px;
  resize: none;
  min-height: 160px;
  line-height: 1.7;
  caret-color: var(--accent-green);
  animation: blink-cursor 1.1s step-end infinite;
}

.compose-footer {
  padding: 10px 12px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.compose-footer .btn-send {
  background: var(--accent-green);
  border: none;
  color: var(--bg-deep);
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  padding: 9px 18px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
}
.compose-footer .btn-send:hover { opacity: 0.85; }

.compose-options {
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 0.1em;
}
.compose-options label {
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  color: var(--text-muted);
}
.compose-options input[type=number] {
  width: 46px;
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--accent-amber);
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 3px 6px;
  outline: none;
}

/* ════════════════════════════════════════════════════════
   ADMIN PANEL (Modal overlay)
════════════════════════════════════════════════════════ */
#admin-overlay {
  position: fixed; inset: 0; z-index: 600;
  background: rgba(10,13,17,0.85);
  display: none;
  overflow-y: auto;
  padding: 24px;
}
#admin-overlay.visible { display: block; }

#admin-panel {
  max-width: 900px;
  margin: 0 auto;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  position: relative;
}
.admin-header {
  padding: 16px 24px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.admin-title {
  font-family: var(--font-mono);
  font-size: 12px;
  letter-spacing: 0.35em;
  color: var(--accent-amber);
  text-transform: uppercase;
}
.admin-close {
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; font-size: 22px; line-height: 1;
}
.admin-close:hover { color: var(--accent-red); }

.admin-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}
.admin-tab {
  padding: 12px 20px;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
}
.admin-tab:hover { color: var(--text-primary); }
.admin-tab.active {
  color: var(--accent-amber);
  border-bottom-color: var(--accent-amber);
}

.admin-content { padding: 20px 24px; }
.admin-section-title {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.3em;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  margin-bottom: 24px;
}
.admin-table th {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.25em;
  color: var(--text-dim);
  text-transform: uppercase;
  text-align: left;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}
.admin-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(42,52,65,0.5);
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 11px;
}
.admin-table tr:hover td { background: var(--bg-hover); }
.admin-table td.handle { color: var(--accent-teal); }
.admin-table td.role-admin { color: var(--accent-amber); }
.admin-table td.actions { display: flex; gap: 6px; }

.btn-sm {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  padding: 4px 8px;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-sm:hover { border-color: var(--accent-green); color: var(--accent-green); }
.btn-sm.red:hover { border-color: var(--accent-red); color: var(--accent-red); }

.admin-form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}
.admin-form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.admin-form-group label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.2em;
  color: var(--text-dim);
  text-transform: uppercase;
}
.admin-form-group input, .admin-form-group select {
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 8px 10px;
  outline: none;
  transition: border-color 0.2s;
}
.admin-form-group input:focus, .admin-form-group select:focus { border-color: var(--accent-amber); }

.btn-admin {
  background: none;
  border: 1px solid var(--accent-amber);
  color: var(--accent-amber);
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  padding: 9px 16px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-admin:hover { background: rgba(212,146,42,0.1); }

.alert-compose {
  display: flex;
  gap: 10px;
  align-items: flex-end;
  margin-bottom: 16px;
}
.alert-compose input {
  flex: 1;
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 9px 12px;
  outline: none;
}
.alert-compose input:focus { border-color: var(--accent-red); }

.audit-entry {
  padding: 8px 0;
  border-bottom: 1px solid rgba(42,52,65,0.4);
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.05em;
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 8px;
}
.audit-time { color: var(--text-dim); }
.audit-entry .from { color: var(--accent-teal); }
.audit-entry .to { color: var(--accent-blue); }

/* NPC list */
.npc-list { margin-bottom: 16px; }
.npc-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border: 1px solid var(--border);
  margin-bottom: 6px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  background: var(--bg-base);
}
.npc-item .npc-name { color: var(--accent-amber); flex: 1; }
.npc-item .npc-handle { color: var(--text-dim); font-size: 10px; }

/* ── REPLY SECTION ──────────────────────────────────── */
.reply-area {
  border-top: 1px solid var(--border);
  padding: 16px 24px;
  flex-shrink: 0;
}
.reply-header {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.2em;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 8px;
}
.reply-area textarea {
  width: 100%;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 13px;
  padding: 10px 12px;
  resize: none;
  outline: none;
  min-height: 80px;
  line-height: 1.6;
  caret-color: var(--accent-green);
  transition: border-color 0.2s;
}
.reply-area textarea:focus { border-color: var(--accent-green); }
.reply-send-row {
  display: flex;
  justify-content: flex-end;
  margin-top: 8px;
}

/* ── GENERIC UTILITY ─────────────────────────────────── */
@keyframes fadein {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.hidden { display: none !important; }

/* Inbox count badge animation */
@keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
.badge-pop { animation: pop 0.3s ease; }

/* GM view-all panel note */
.gm-inbox-switcher {
  padding: 8px 12px;
  background: rgba(212,146,42,0.06);
  border-bottom: 1px solid var(--border);
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 0.1em;
}
.gm-inbox-switcher select {
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--accent-amber);
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 4px 8px;
  margin-left: 8px;
  outline: none;
}

/* Private thread panel in admin */
.thread-list { }
.thread-item {
  padding: 10px 12px;
  border: 1px solid var(--border);
  margin-bottom: 6px;
  cursor: pointer;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  transition: background 0.15s;
}
.thread-item:hover { background: var(--bg-hover); }
.thread-item .thread-players { color: var(--accent-amber); margin-bottom: 3px; }
.thread-item .thread-last { color: var(--text-dim); font-size: 10px; }

/* Responsive */
@media (max-width: 768px) {
  #sidebar { width: 180px; min-width: 180px; }
  #email-list-panel { width: 240px; min-width: 200px; }
}
@media (max-width: 600px) {
  #sidebar { display: none; }
  #email-list-panel { width: 100%; }
  #message-detail { display: none; }
  #message-detail.mobile-active { display: flex; }
}
</style>
</head>
<body>

<!-- ══════════════════════════════════════════════════
     FIREBASE LOADING SCREEN
     Displayed on first load while we fetch the initial
     database snapshot from the cloud.  The JS init code
     at the bottom will hide this once data is ready.
══════════════════════════════════════════════════ -->
<div id="loading-screen">
  <div class="loading-title">&#9632; Delta Green // Secure Channel &#9632;</div>
  <div class="loading-bar-wrap"><div class="loading-bar-fill"></div></div>
  <div class="loading-status" id="loading-status-text">ESTABLISHING ENCRYPTED CONNECTION…</div>
</div>

<!-- ══════════════════════════════════════════════════
     LOGIN SCREEN
══════════════════════════════════════════════════ -->
<div id="login-screen">
  <div class="login-scanline"></div>

  <div class="login-logo">
    <div class="agency-name">&#9632; U.S. Dept. of Defense &mdash; Unacknowledged Special Access Program &#9632;</div>
    <div class="agency-slash">DELTA GREEN<br>// EYES ONLY</div>
    <div class="agency-sub">Program Node ALPHA-7 &bull; Compartmented Channel &bull; v4.7.2</div>
  </div>

  <div class="login-box">
    <h2>&#128274; Agent Authentication</h2>

    <div class="login-field">
      <label>Select Operative</label>
      <select id="login-account-select"></select>
    </div>

    <div class="login-field">
      <label>Access Code</label>
      <input type="password" id="login-password" placeholder="••••••••••" autocomplete="off">
    </div>

    <button class="btn-primary" onclick="attemptLogin()">
      <span class="material-icons" style="font-size:13px;vertical-align:middle;margin-right:6px;">fingerprint</span>
      Authenticate
    </button>

    <div class="login-error" id="login-error"></div>

    <div class="login-hint">
      Press <kbd style="background:var(--bg-base);padding:1px 5px;border:1px solid var(--border);font-family:var(--font-mono);font-size:9px;">SHIFT+G+M</kbd>
      for Director access
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════
     MAIN APP
══════════════════════════════════════════════════ -->
<div id="app">
  <!-- HEADER -->
  <div id="header">
    <div class="header-brand">
      DELTA GREEN<span>/</span><span>/</span> EYES&nbsp;ONLY
    </div>
    <div class="classification-badge">CLASSIFICATION: UMBRA // EYES ONLY</div>

    <div class="header-spacer"></div>

    <div id="system-alert-toggle" class="hidden">
      <button class="btn-icon" onclick="showAdminPanel('alerts')">
        <span class="material-icons">broadcast_on_personal</span> Alert
      </button>
    </div>

    <button class="btn-icon" id="admin-btn" onclick="showAdminPanel('accounts')" style="display:none;">
      <span class="material-icons">shield</span> Director
    </button>

    <div class="header-user">
      <div class="header-user-info">
        <div class="header-user-handle" id="header-handle">—</div>
        <div class="header-user-role" id="header-role">—</div>
      </div>
      <button class="btn-icon danger" onclick="logout()">
        <span class="material-icons">logout</span>
        Switch
      </button>
    </div>
  </div>

  <!-- SYSTEM ALERT BANNER -->
  <div id="system-alert">
    <span class="material-icons" style="color:var(--accent-red);font-size:15px;">warning</span>
    <span class="alert-label">System Alert</span>
    <span class="alert-text" id="alert-text"></span>
    <button id="dismiss-alert" onclick="dismissAlert()">&#10005;</button>
  </div>

  <!-- WORKSPACE -->
  <div id="workspace">
    <!-- SIDEBAR -->
    <div id="sidebar">
      <button class="compose-btn" onclick="openCompose()">
        <span class="material-icons">edit</span>
        New Transmission
      </button>

      <div id="gm-inbox-switcher" class="gm-inbox-switcher hidden">
        Viewing:
        <select id="gm-view-select" onchange="gmSwitchView()">
          <option value="__all">All Messages</option>
        </select>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Channels</div>
        <div class="sidebar-item active" onclick="setFolder('inbox')" id="folder-inbox">
          <span class="material-icons">inbox</span>
          Inbox
          <span class="badge" id="unread-badge" style="display:none">0</span>
        </div>
        <div class="sidebar-item" onclick="setFolder('sent')" id="folder-sent">
          <span class="material-icons">send</span>
          Sent
        </div>
      </div>

      <div class="sidebar-divider"></div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Classified</div>
        <div class="sidebar-item" onclick="setFolder('eyes-only')" id="folder-eyes-only">
          <span class="material-icons">visibility_off</span>
          Eyes Only
        </div>
        <div class="sidebar-item" onclick="setFolder('burn')" id="folder-burn">
          <span class="material-icons">local_fire_department</span>
          Burn After Reading
          <span class="badge amber" id="selfdestruct-badge" style="display:none">!</span>
        </div>
        <div class="sidebar-item" onclick="setFolder('intercepted')" id="folder-intercepted">
          <span class="material-icons">block</span>
          Intercepted
        </div>
      </div>

      <div class="sidebar-divider"></div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Archive</div>
        <div class="sidebar-item" onclick="setFolder('archive')" id="folder-archive">
          <span class="material-icons">folder_special</span>
          Archive
        </div>
        <div class="sidebar-item" onclick="setFolder('trash')" id="folder-trash">
          <span class="material-icons">delete</span>
          Trash
        </div>
      </div>
    </div>

    <!-- EMAIL LIST -->
    <div id="email-list-panel">
      <div class="panel-header">
        <div class="panel-title" id="panel-title">Inbox</div>
        <div class="panel-count" id="panel-count"></div>
      </div>
      <div id="email-list"></div>
    </div>

    <!-- MESSAGE DETAIL -->
    <div id="message-detail">
      <div class="detail-empty" id="detail-empty">
        <span class="material-icons">lock</span>
        <p>No Transmission Selected</p>
      </div>

      <div id="detail-view" class="hidden" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
        <div class="detail-header">
          <div class="detail-subject" id="detail-subject"></div>
          <div class="detail-meta">
            <span class="detail-meta-label">From:</span>
            <span class="detail-meta-value" id="detail-from"></span>
            <span class="detail-meta-label">To:</span>
            <span class="detail-meta-value" id="detail-to"></span>
            <span class="detail-meta-label">Time:</span>
            <span class="detail-meta-value" id="detail-time"></span>
          </div>
        </div>

        <div class="detail-actions">
          <button class="btn-icon" onclick="replyToMessage()">
            <span class="material-icons">reply</span> Reply
          </button>
          <button class="btn-icon" onclick="moveToArchive()">
            <span class="material-icons">archive</span> Archive
          </button>
          <button class="btn-icon danger" onclick="moveToTrash()">
            <span class="material-icons">delete</span> Trash
          </button>
          <div id="gm-message-actions" class="hidden" style="margin-left:auto;display:flex;gap:8px;">
            <button class="btn-icon" onclick="gmInterceptMessage()" title="Intercept (GM only)">
              <span class="material-icons">block</span> Intercept
            </button>
            <button class="btn-icon danger" onclick="gmDeleteMessage()">
              <span class="material-icons">delete_forever</span> Purge
            </button>
          </div>
        </div>

        <div id="secure-banner-slot"></div>

        <div class="detail-body" id="detail-body-scroll">
          <div class="detail-body-text" id="detail-body"></div>
          <div id="selfdestruct-display" class="hidden selfdestruct-timer">
            <span class="material-icons">hourglass_top</span>
            <span id="selfdestruct-countdown"></span>
          </div>
        </div>

        <div class="reply-area" id="reply-area" style="display:none">
          <div class="reply-header">Reply Transmission</div>
          <textarea id="reply-text" placeholder="Compose your response..."></textarea>
          <div class="reply-send-row">
            <button class="btn-icon" onclick="sendReply()">
              <span class="material-icons">send</span> Transmit
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- COMPOSE MODAL -->
<div id="compose-overlay">
  <div id="compose-window">
    <div class="compose-window-header">
      <span class="compose-window-title">
        <span class="material-icons" style="font-size:12px;vertical-align:middle;">send</span>
        New Encrypted Transmission
      </span>
      <button class="compose-close" onclick="closeCompose()">&#10005;</button>
    </div>

    <div id="gm-send-as-row" class="compose-field hidden">
      <span class="compose-field-label">Send As</span>
      <select id="compose-send-as"></select>
    </div>

    <div class="compose-field">
      <span class="compose-field-label">To</span>
      <select id="compose-to" multiple style="min-height:60px;background:var(--bg-base);border:none;outline:none;color:var(--text-primary);font-family:var(--font-mono);font-size:12px;padding:8px;flex:1;"></select>
    </div>

    <div class="compose-field">
      <span class="compose-field-label">Subject</span>
      <input type="text" id="compose-subject" placeholder="Classification Required">
    </div>

    <div class="compose-body">
      <textarea id="compose-body" placeholder="Transmission body...&#10;&#10;Use &lt;span class='redacted'&gt;classified text&lt;/span&gt; to redact portions."></textarea>
    </div>

    <div class="compose-footer">
      <button class="btn-send" onclick="sendMessage()">
        <span class="material-icons" style="font-size:12px;vertical-align:middle;">send</span>
        Transmit
      </button>

      <div class="compose-options">
        <label title="Move to Eyes Only folder for recipients">
          <input type="checkbox" id="opt-eyes-only"> Eyes Only
        </label>
        <label title="Message auto-deletes after read">
          <input type="checkbox" id="opt-selfdestruct"> Burn in
          <input type="number" id="opt-selfdestruct-seconds" value="30" min="5" max="300" style="width:46px;background:var(--bg-base);border:1px solid var(--border);color:var(--accent-amber);font-family:var(--font-mono);font-size:10px;padding:2px 5px;outline:none;">s
        </label>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-overlay">
  <div id="admin-panel">
    <div class="admin-header">
      <span class="admin-title">
        <span class="material-icons" style="font-size:14px;vertical-align:middle;margin-right:8px;">shield</span>
        Director Control Panel
      </span>
      <button class="admin-close" onclick="closeAdminPanel()">&#10005;</button>
    </div>

    <div class="admin-tabs">
      <div class="admin-tab active" onclick="switchAdminTab('accounts')" data-tab="accounts">Operatives</div>
      <div class="admin-tab" onclick="switchAdminTab('npcs')" data-tab="npcs">NPC Library</div>
      <div class="admin-tab" onclick="switchAdminTab('threads')" data-tab="threads">Private Threads</div>
      <div class="admin-tab" onclick="switchAdminTab('alerts')" data-tab="alerts">Alerts</div>
      <div class="admin-tab" onclick="switchAdminTab('audit')" data-tab="audit">Audit Log</div>
    </div>

    <!-- ACCOUNTS TAB -->
    <div class="admin-content" id="admin-tab-accounts">
      <div class="admin-section-title">Registered Agents</div>
      <table class="admin-table" id="accounts-table">
        <thead>
          <tr>
            <th>Handle</th>
            <th>Role</th>
            <th>Inbox Count</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="accounts-table-body"></tbody>
      </table>

      <div class="admin-section-title">Add Agent</div>
      <div class="admin-form">
        <div class="admin-form-group">
          <label>Display Name</label>
          <input type="text" id="new-name" placeholder="Agent SIERRA">
        </div>
        <div class="admin-form-group">
          <label>Agency Handle</label>
          <input type="text" id="new-handle" placeholder="a-sierra@sap.dod.gov">
        </div>
        <div class="admin-form-group">
          <label>Username (login)</label>
          <input type="text" id="new-username" placeholder="scarlett">
        </div>
        <div class="admin-form-group">
          <label>Password</label>
          <input type="password" id="new-password" placeholder="••••••••">
        </div>
      </div>
      <button class="btn-admin" onclick="addAccount()">+ Add Agent</button>
    </div>

    <!-- NPCs TAB -->
    <div class="admin-content hidden" id="admin-tab-npcs">
      <div class="admin-section-title">NPC Identity Library</div>
      <div class="npc-list" id="npc-list"></div>

      <div class="admin-form">
        <div class="admin-form-group">
          <label>NPC Name / Codename</label>
          <input type="text" id="npc-name" placeholder="Case Officer ALPHONSE">
        </div>
        <div class="admin-form-group">
          <label>NPC Address</label>
          <input type="text" id="npc-handle" placeholder="c-alphonse@sap.dod.gov">
        </div>
        <div class="admin-form-group" style="grid-column:1/-1">
          <label>Signature Footer (optional)</label>
          <input type="text" id="npc-sig" placeholder="— ALPHONSE | Case Officer | Delta Green Program">
        </div>
      </div>
      <button class="btn-admin" onclick="addNpc()">+ Add NPC Identity</button>
    </div>

    <!-- PRIVATE THREADS -->
    <div class="admin-content hidden" id="admin-tab-threads">
      <div class="admin-section-title">Private NPC ↔ Operative Threads</div>
      <div id="thread-list-panel" class="thread-list"></div>
    </div>

    <!-- ALERTS TAB -->
    <div class="admin-content hidden" id="admin-tab-alerts">
      <div class="admin-section-title">Broadcast System Alert</div>
      <p style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);margin-bottom:16px;letter-spacing:0.05em;">
        System alerts appear as a blinking banner at the top of every player's inbox simultaneously.
      </p>
      <div class="alert-compose">
        <input type="text" id="alert-input" placeholder="Enter alert message...">
        <button class="btn-admin" style="border-color:var(--accent-red);color:var(--accent-red);" onclick="broadcastAlert()">
          Broadcast
        </button>
      </div>
      <button class="btn-sm" onclick="clearAlert()">Clear Active Alert</button>
    </div>

    <!-- AUDIT LOG -->
    <div class="admin-content hidden" id="admin-tab-audit">
      <div class="admin-section-title">Message Audit Log</div>
      <div id="audit-log-panel"></div>
    </div>

  </div>
</div>

<script>
// ════════════════════════════════════════════════════════
//  DATA LAYER – Firebase Realtime Database
//
//  HOW THIS WORKS
//  ──────────────
//  Instead of writing to localStorage (which only exists
//  in one browser), we now read from and write to a single
//  shared JSON tree in Firebase's cloud database.
//
//  saveData(data)
//    Calls .set() on the Firebase ref.  This overwrites
//    the entire game document with the new state.  It
//    returns a Promise but we don't await it — the UI
//    updates immediately from the local DB object, and
//    Firebase confirms in the background.
//
//  The real-time listener (set up in initApp below)
//    Firebase calls our callback function EVERY TIME the
//    database changes — whether the change came from the
//    GM, from a player on another device, or from this
//    very browser.  That's how messages appear instantly
//    on all screens without anyone pressing refresh.
//
//  _isWriting flag
//    When WE call saveData(), Firebase fires the listener
//    a moment later with our own change.  Without the flag
//    we'd re-render the whole UI mid-action (e.g. while
//    the compose window is open).  The flag suppresses
//    that one redundant re-render.
// ════════════════════════════════════════════════════════

let _isWriting = false;   // prevents echoing our own saves back into the UI

function saveData(data) {
  _isWriting = true;
  GAME_REF.set(data)
    .catch(err => {
      console.error('[DG] Firebase write error:', err);
      // Fall back to localStorage so a network blip doesn't lose data
      try { localStorage.setItem('dg_backup', JSON.stringify(data)); } catch(e){}
    })
    .finally(() => {
      // Give Firebase ~300 ms to call the listener before we clear the flag.
      // This prevents our own save from triggering a redundant re-render.
      setTimeout(() => { _isWriting = false; }, 300);
    });
}

function getDefaultData() {
  return {
    accounts: [
      { id: 'gm', username: 'director', name: 'The Outliner', handle: 'director@sap.dod.gov', password: 'gm123', role: 'admin' },
      { id: 'scarlett', username: 'scarlett', name: 'Agent SIERRA', handle: 'a-sierra@sap.dod.gov', password: 'scarlett', role: 'player' },
      { id: 'wolf', username: 'wolf', name: 'Agent WOLF', handle: 'operative.wolf@sap.dod.gov', password: 'wolf', role: 'player' },
      { id: 'cipher', username: 'cipher', name: 'Agent CIPHER', handle: 'operative.cipher@sap.dod.gov', password: 'cipher', role: 'player' },
    ],
    npcs: [
      { id: 'npc-voss', name: 'Case Officer ALPHONSE', handle: 'c-alphonse@sap.dod.gov', sig: '— ALPHONSE | Program Case Officer | Delta Green' },
      { id: 'npc-nightbird', name: 'ASSET: NIGHTBIRD', handle: 'asset.nightbird@unknown.net', sig: '' },
      { id: 'npc-unknown', name: 'UNKNOWN SENDER', handle: 'no-reply@anonymous.onion', sig: '' },
      { id: 'npc-majestic', name: 'MAJESTIC CONTROL', handle: 'no-reply@mjtwelve.mil', sig: '— MJ-12 // EXECUTIVE AUTHORITY // DO NOT ARCHIVE' },
    ],
    messages: [
      {
        id: 'msg-001',
        from: 'c-alphonse@sap.dod.gov',
        to: ['a-sierra@sap.dod.gov', 'operative.wolf@sap.dod.gov', 'operative.cipher@sap.dod.gov'],
        subject: 'OPERATION STATIC HYMN — Briefing',
        body: `Operatives,\n\nYour assignment has been authorized at the highest level. Your contact in Prague has been compromised. Proceed with extreme caution.\n\nObjective: Retrieve the <span class='redacted'>BLACKWATER dossier</span> from <span class='redacted'>Checkpoint Zeta, Sub-Level 3</span> before extraction window closes at 0400 local time.\n\nDo not contact <span class='redacted'>Asset NIGHTBIRD</span> via conventional channels. Use the dead drop protocol.\n\nThis transmission will be logged. Operational security is your responsibility.\n\n— ALPHONSE | Program Case Officer | Delta Green`,
        folder: { 'a-sierra@sap.dod.gov': 'inbox', 'operative.wolf@sap.dod.gov': 'inbox', 'operative.cipher@sap.dod.gov': 'inbox' },
        timestamp: new Date(Date.now() - 3600000 * 2).toISOString(),
        read: {},
        isNpc: true,
        privateThread: false,
      },
      {
        id: 'msg-002',
        from: 'asset.nightbird@unknown.net',
        to: ['a-sierra@sap.dod.gov'],
        subject: '[ENCRYPTED SOURCE] The briefing is incomplete.',
        body: `SIERRA.\n\nThey swept the Galveston motel. Three men. They didn't look right. Moved wrong.\n\nThe briefing your Case Officer sent is <span class='redacted'>incomplete</span>. ALPHONSE is not telling you everything about VERMEER. I've seen the <span class='redacted'>Majestic files</span>. What's in that warehouse is not the INDEX.\n\nDo not reply to this address. It routes nowhere twice.\n\n— N`,
        folder: { 'a-sierra@sap.dod.gov': 'inbox' },
        timestamp: new Date(Date.now() - 1800000).toISOString(),
        read: {},
        isNpc: true,
        privateThread: true,
        selfDestruct: 60,
      },
      {
        id: 'msg-003',
        from: 'operative.wolf@sap.dod.gov',
        to: ['operative.cipher@sap.dod.gov'],
        subject: 'Re: South Entrance — Do Not Forward',
        body: `Cipher,\n\nGot your message. I can cover the south entrance if you handle comms. Bring the signal jammer — we'll need 40 seconds minimum of blackout.\n\nDon't tell Case Officer ALPHONSE. This isn't in the briefing.\n\n— Wolf`,
        folder: { 'operative.cipher@sap.dod.gov': 'inbox', 'operative.wolf@sap.dod.gov': 'sent' },
        timestamp: new Date(Date.now() - 900000).toISOString(),
        read: {},
        isNpc: false,
        privateThread: false,
      },
    ],
    audit: [],
    systemAlert: null,
  };
}

// DB starts empty — Firebase's real-time listener populates it
// asynchronously on first snapshot (see initApp() at the bottom).
let DB = {};

// ════════════════════════════════════════════════════════
//  STATE
// ════════════════════════════════════════════════════════
let currentUser = null;
let currentFolder = 'inbox';
let selectedMessageId = null;
let selfDestructTimer = null;
let gmViewingUser = '__all';

// ════════════════════════════════════════════════════════
//  LOGIN
// ════════════════════════════════════════════════════════
function populateLoginDropdown() {
  const sel = document.getElementById('login-account-select');
  sel.innerHTML = '';
  DB.accounts.filter(a => a.role === 'player').forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.username;
    opt.textContent = `${a.name} — ${a.handle}`;
    sel.appendChild(opt);
  });
}

function attemptLogin() {
  const username = document.getElementById('login-account-select').value;
  const password = document.getElementById('login-password').value;
  const account = DB.accounts.find(a => a.username === username && a.password === password);
  if (!account) {
    document.getElementById('login-error').textContent = '▸ ACCESS DENIED — Invalid credentials';
    return;
  }
  loginAs(account);
}

function loginAs(account) {
  currentUser = account;
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.add('visible');
  document.getElementById('header-handle').textContent = account.handle;
  document.getElementById('header-role').textContent = account.role === 'admin' ? 'Program Director // Admin' : 'Operative // Player';

  const adminBtn = document.getElementById('admin-btn');
  const alertToggle = document.getElementById('system-alert-toggle');

  if (account.role === 'admin') {
    adminBtn.style.display = 'block';
    alertToggle.classList.remove('hidden');
    document.getElementById('gm-inbox-switcher').classList.remove('hidden');
    document.getElementById('gm-message-actions').classList.remove('hidden');
    populateGmViewSelect();
  } else {
    adminBtn.style.display = 'none';
    alertToggle.classList.add('hidden');
    document.getElementById('gm-inbox-switcher').classList.add('hidden');
    document.getElementById('gm-message-actions').classList.add('hidden');
  }

  currentFolder = 'inbox';
  selectedMessageId = null;
  gmViewingUser = '__all';
  renderFolderActive();
  renderEmailList();
  showSystemAlert();
}

function logout() {
  currentUser = null;
  selectedMessageId = null;
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-error').textContent = '';
  document.getElementById('login-password').value = '';
  document.getElementById('detail-empty').classList.remove('hidden');
  document.getElementById('detail-view').classList.add('hidden');
  if (selfDestructTimer) clearInterval(selfDestructTimer);
  populateLoginDropdown();
}

// Hidden GM login via Shift+G+M
let gmKeys = [];
document.addEventListener('keydown', (e) => {
  if (e.shiftKey && ['g','m'].includes(e.key.toLowerCase())) {
    gmKeys.push(e.key.toLowerCase());
    if (gmKeys.includes('g') && gmKeys.includes('m')) {
      gmKeys = [];
      const pwd = prompt('Director access code:');
      const gm = DB.accounts.find(a => a.role === 'admin' && a.password === pwd);
      if (gm) {
        if (currentUser) logout();
        setTimeout(() => {
          document.getElementById('login-screen').classList.add('hidden');
          loginAs(gm);
        }, 50);
      }
    }
  }
});

// ════════════════════════════════════════════════════════
//  MESSAGE FETCHING
// ════════════════════════════════════════════════════════
function getMessagesForFolder(folder) {
  if (!currentUser) return [];

  if (currentUser.role === 'admin') {
    const viewUser = gmViewingUser === '__all' ? null : gmViewingUser;
    return DB.messages.filter(m => {
      if (viewUser) {
        const inFolder = m.folder && m.folder[viewUser] === folder;
        const isRecip = m.to.includes(viewUser) || m.from === viewUser;
        return inFolder || (folder === 'inbox' && isRecip && !m.folder?.[viewUser]);
      }
      // All messages
      if (folder === 'inbox') return !m.deleted;
      if (folder === 'sent') return false;
      return false;
    }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  }

  const handle = currentUser.handle;
  return DB.messages.filter(m => {
    if (m.deleted_for?.[handle]) return false;
    const f = m.folder?.[handle];
    if (folder === 'inbox') {
      return m.to.includes(handle) && (!f || f === 'inbox');
    }
    if (folder === 'sent') {
      return m.from === handle && (!f || f === 'sent');
    }
    return f === folder;
  }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
}

function getUnreadCount() {
  if (!currentUser) return 0;
  const handle = currentUser.handle;
  return DB.messages.filter(m => {
    if (m.deleted_for?.[handle]) return false;
    const f = m.folder?.[handle];
    const inInbox = m.to.includes(handle) && (!f || f === 'inbox');
    return inInbox && !m.read?.[handle];
  }).length;
}

// ════════════════════════════════════════════════════════
//  RENDER EMAIL LIST
// ════════════════════════════════════════════════════════
function renderEmailList() {
  const list = document.getElementById('email-list');
  const messages = getMessagesForFolder(currentFolder);
  const handle = currentUser?.handle;

  list.innerHTML = '';
  document.getElementById('panel-title').textContent = folderLabel(currentFolder);
  document.getElementById('panel-count').textContent = `${messages.length} transmission${messages.length !== 1 ? 's' : ''}`;

  const unread = getUnreadCount();
  const badge = document.getElementById('unread-badge');
  if (unread > 0) {
    badge.style.display = 'inline';
    badge.textContent = unread;
  } else {
    badge.style.display = 'none';
  }

  // Self-destruct badge
  const sd = DB.messages.filter(m => m.selfDestruct && m.to.includes(handle) && !m.selfDestructOpened).length;
  const sdBadge = document.getElementById('selfdestruct-badge');
  sdBadge.style.display = sd > 0 ? 'inline' : 'none';

  if (messages.length === 0) {
    list.innerHTML = '<div class="empty-state">▸ NO TRANSMISSIONS<br>CHANNEL CLEAR</div>';
    return;
  }

  messages.forEach((msg, i) => {
    const isUnread = handle && !msg.read?.[handle] && msg.to?.includes(handle);
    const isNpc = msg.isNpc;
    const isIntercepted = msg.intercepted;
    const displaySender = getNpcName(msg.from) || msg.from;

    const item = document.createElement('div');
    item.className = `email-item${isUnread ? ' unread' : ''}${isNpc ? ' npc-source' : ''}${isIntercepted ? ' intercepted' : ''}${msg.id === selectedMessageId ? ' active' : ''}`;
    item.style.animationDelay = `${i * 0.04}s`;
    item.onclick = () => openMessage(msg.id);

    const senderBadge = isNpc ? `<span class="sender-badge badge-encrypted">[ENCRYPTED SOURCE]</span>` :
                        isIntercepted ? `<span class="sender-badge badge-intercepted">[INTERCEPTED]</span>` : '';

    item.innerHTML = `
      <div class="email-time">${formatTime(msg.timestamp)}</div>
      <div class="email-sender">${escHtml(displaySender)}${senderBadge}</div>
      <div class="email-subject">${escHtml(msg.subject)}</div>
      <div class="email-preview">${stripHtml(msg.body).substring(0, 60)}…</div>
    `;
    list.appendChild(item);
  });
}

function folderLabel(f) {
  const map = { inbox:'Inbox', sent:'Sent', 'eyes-only':'Eyes Only', burn:'Burn After Reading', intercepted:'Intercepted', archive:'Archive', trash:'Trash' };
  return map[f] || f;
}

function setFolder(folder) {
  currentFolder = folder;
  selectedMessageId = null;
  renderFolderActive();
  renderEmailList();
  document.getElementById('detail-empty').classList.remove('hidden');
  document.getElementById('detail-view').classList.add('hidden');
}

function renderFolderActive() {
  document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(`folder-${currentFolder}`);
  if (el) el.classList.add('active');
}

// ════════════════════════════════════════════════════════
//  OPEN MESSAGE
// ════════════════════════════════════════════════════════
function openMessage(msgId) {
  const msg = DB.messages.find(m => m.id === msgId);
  if (!msg) return;
  const handle = currentUser?.handle;

  selectedMessageId = msgId;

  // Mark as read
  if (handle && !msg.read) msg.read = {};
  if (handle) msg.read[handle] = new Date().toISOString();
  saveData(DB);

  renderEmailList();

  // Show detail view
  document.getElementById('detail-empty').classList.add('hidden');
  document.getElementById('detail-view').classList.remove('hidden');

  document.getElementById('detail-subject').textContent = msg.subject;

  const fromEl = document.getElementById('detail-from');
  const npcName = getNpcName(msg.from);
  fromEl.textContent = npcName ? `${npcName} <${msg.from}>` : msg.from;
  fromEl.className = `detail-meta-value ${msg.isNpc ? 'npc-sender' : 'sender'}`;

  document.getElementById('detail-to').textContent = msg.to.join(', ');
  document.getElementById('detail-time').textContent = formatDateTime(msg.timestamp);
  document.getElementById('detail-body').innerHTML = msg.body;

  // Secure channel banner for player-to-player
  const bannerSlot = document.getElementById('secure-banner-slot');
  bannerSlot.innerHTML = '';
  if (!msg.isNpc && msg.from !== currentUser?.handle) {
    const banner = document.createElement('div');
    banner.className = 'secure-channel-banner';
    banner.innerHTML = `<span class="material-icons" style="font-size:13px;">lock</span> SECURE CHANNEL ESTABLISHED — ${escHtml(msg.from)}`;
    bannerSlot.appendChild(banner);
  }

  // Reply area
  const replyArea = document.getElementById('reply-area');
  replyArea.style.display = currentFolder !== 'sent' ? 'block' : 'none';
  document.getElementById('reply-text').value = '';

  // Self-destruct
  if (selfDestructTimer) clearInterval(selfDestructTimer);
  const sdDisplay = document.getElementById('selfdestruct-display');
  sdDisplay.classList.add('hidden');

  if (msg.selfDestruct && !msg.selfDestructDone && handle && msg.to.includes(handle)) {
    let remaining = msg.selfDestruct;
    sdDisplay.classList.remove('hidden');
    document.getElementById('selfdestruct-countdown').textContent = `MESSAGE WILL SELF-DESTRUCT IN ${remaining}s`;
    selfDestructTimer = setInterval(() => {
      remaining--;
      document.getElementById('selfdestruct-countdown').textContent = `MESSAGE WILL SELF-DESTRUCT IN ${remaining}s`;
      if (remaining <= 0) {
        clearInterval(selfDestructTimer);
        // Move to trash for this user
        if (!msg.deleted_for) msg.deleted_for = {};
        msg.deleted_for[handle] = true;
        msg.selfDestructDone = true;
        saveData(DB);
        document.getElementById('detail-empty').classList.remove('hidden');
        document.getElementById('detail-view').classList.add('hidden');
        selectedMessageId = null;
        renderEmailList();
      }
    }, 1000);
  }

  // GM actions visibility
  const gmActions = document.getElementById('gm-message-actions');
  if (currentUser?.role === 'admin') {
    gmActions.classList.remove('hidden');
    gmActions.style.display = 'flex';
  }
}

// ════════════════════════════════════════════════════════
//  COMPOSE
// ════════════════════════════════════════════════════════
function openCompose(replyTo) {
  const overlay = document.getElementById('compose-overlay');
  overlay.classList.add('visible');

  // Populate To dropdown
  const toSel = document.getElementById('compose-to');
  toSel.innerHTML = '';
  DB.accounts.filter(a => a.role === 'player').forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.handle;
    opt.textContent = `${a.name} — ${a.handle}`;
    if (replyTo && replyTo === a.handle) opt.selected = true;
    toSel.appendChild(opt);
  });

  // GM Send As
  const sendAsRow = document.getElementById('gm-send-as-row');
  const sendAsSel = document.getElementById('compose-send-as');
  if (currentUser?.role === 'admin') {
    sendAsRow.classList.remove('hidden');
    sendAsSel.innerHTML = '';
    // GM self
    const gmOpt = document.createElement('option');
    gmOpt.value = currentUser.handle;
    gmOpt.textContent = `${currentUser.name} [Program Director]`;
    sendAsSel.appendChild(gmOpt);
    // Player accounts
    DB.accounts.filter(a => a.role === 'player').forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.handle;
      opt.textContent = `${a.name} [Agent]`;
      sendAsSel.appendChild(opt);
    });
    // NPCs
    DB.npcs.forEach(n => {
      const opt = document.createElement('option');
      opt.value = n.handle;
      opt.textContent = `${n.name} [Asset/Source] `;
      sendAsSel.appendChild(opt);
    });
  } else {
    sendAsRow.classList.add('hidden');
  }

  if (replyTo) {
    document.getElementById('compose-subject').value = '';
  } else {
    document.getElementById('compose-subject').value = '';
    document.getElementById('compose-body').value = '';
  }
}

function closeCompose() {
  document.getElementById('compose-overlay').classList.remove('visible');
}

function sendMessage() {
  const toSel = document.getElementById('compose-to');
  const to = Array.from(toSel.selectedOptions).map(o => o.value);
  const subject = document.getElementById('compose-subject').value.trim();
  const body = document.getElementById('compose-body').value.trim();

  if (!to.length) { alert('Select at least one recipient.'); return; }
  if (!subject) { alert('Subject required.'); return; }
  if (!body) { alert('Message body required.'); return; }

  const fromHandle = currentUser?.role === 'admin'
    ? document.getElementById('compose-send-as').value
    : currentUser.handle;

  const isNpc = DB.npcs.some(n => n.handle === fromHandle);
  const eyesOnly = document.getElementById('opt-eyes-only').checked;
  const selfDestruct = document.getElementById('opt-selfdestruct').checked
    ? parseInt(document.getElementById('opt-selfdestruct-seconds').value)
    : null;

  // Add NPC signature if applicable
  let finalBody = body;
  const npc = DB.npcs.find(n => n.handle === fromHandle);
  if (npc?.sig) finalBody += `\n\n${npc.sig}`;

  const folder = {};
  to.forEach(h => { folder[h] = eyesOnly ? 'eyes-only' : 'inbox'; });
  // Also track in sender's sent
  folder[fromHandle] = 'sent';

  const msg = {
    id: `msg-${Date.now()}`,
    from: fromHandle,
    to,
    subject,
    body: finalBody,
    folder,
    timestamp: new Date().toISOString(),
    read: {},
    isNpc,
    privateThread: to.length === 1,
    selfDestruct,
  };

  DB.messages.unshift(msg);
  DB.audit.unshift({ time: new Date().toISOString(), from: fromHandle, to: to.join(', '), subject });
  saveData(DB);

  closeCompose();
  renderEmailList();
}

function replyToMessage() {
  if (!selectedMessageId) return;
  const msg = DB.messages.find(m => m.id === selectedMessageId);
  if (!msg) return;
  document.getElementById('reply-area').style.display = 'block';
  document.getElementById('reply-text').focus();
}

function sendReply() {
  if (!selectedMessageId) return;
  const msg = DB.messages.find(m => m.id === selectedMessageId);
  if (!msg) return;

  const body = document.getElementById('reply-text').value.trim();
  if (!body) return;

  const fromHandle = currentUser.handle;
  const toHandle = msg.from === fromHandle ? msg.to.filter(h => h !== fromHandle) : [msg.from];
  const allTo = toHandle.length ? toHandle : [msg.from];

  const folder = {};
  allTo.forEach(h => { folder[h] = 'inbox'; });
  folder[fromHandle] = 'sent';

  const reply = {
    id: `msg-${Date.now()}`,
    from: fromHandle,
    to: allTo,
    subject: msg.subject.startsWith('Re:') ? msg.subject : `Re: ${msg.subject}`,
    body,
    folder,
    timestamp: new Date().toISOString(),
    read: {},
    isNpc: false,
    privateThread: allTo.length === 1,
    selfDestruct: null,
  };

  DB.messages.unshift(reply);
  DB.audit.unshift({ time: new Date().toISOString(), from: fromHandle, to: allTo.join(', '), subject: reply.subject });
  saveData(DB);

  document.getElementById('reply-text').value = '';
  document.getElementById('reply-area').style.display = 'none';
  renderEmailList();
  openMessage(reply.id);
}

// ════════════════════════════════════════════════════════
//  FOLDER ACTIONS
// ════════════════════════════════════════════════════════
function moveToArchive() {
  if (!selectedMessageId || !currentUser) return;
  const msg = DB.messages.find(m => m.id === selectedMessageId);
  if (!msg) return;
  const h = currentUser.handle;
  if (!msg.folder) msg.folder = {};
  msg.folder[h] = 'archive';
  saveData(DB);
  selectedMessageId = null;
  document.getElementById('detail-empty').classList.remove('hidden');
  document.getElementById('detail-view').classList.add('hidden');
  renderEmailList();
}

function moveToTrash() {
  if (!selectedMessageId || !currentUser) return;
  const msg = DB.messages.find(m => m.id === selectedMessageId);
  if (!msg) return;
  const h = currentUser.handle;
  if (!msg.folder) msg.folder = {};
  msg.folder[h] = 'trash';
  saveData(DB);
  selectedMessageId = null;
  document.getElementById('detail-empty').classList.remove('hidden');
  document.getElementById('detail-view').classList.add('hidden');
  renderEmailList();
}

// ════════════════════════════════════════════════════════
//  GM ACTIONS
// ════════════════════════════════════════════════════════
function gmInterceptMessage() {
  if (!selectedMessageId) return;
  const msg = DB.messages.find(m => m.id === selectedMessageId);
  if (!msg) return;
  msg.intercepted = !msg.intercepted;
  saveData(DB);
  renderEmailList();
  openMessage(selectedMessageId);
}

function gmDeleteMessage() {
  if (!selectedMessageId) return;
  if (!confirm('Permanently purge this transmission?')) return;
  DB.messages = DB.messages.filter(m => m.id !== selectedMessageId);
  saveData(DB);
  selectedMessageId = null;
  document.getElementById('detail-empty').classList.remove('hidden');
  document.getElementById('detail-view').classList.add('hidden');
  renderEmailList();
}

function populateGmViewSelect() {
  const sel = document.getElementById('gm-view-select');
  sel.innerHTML = '<option value="__all">All Inboxes</option>';
  DB.accounts.filter(a => a.role === 'player').forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.handle;
    opt.textContent = a.name;
    sel.appendChild(opt);
  });
}

function gmSwitchView() {
  gmViewingUser = document.getElementById('gm-view-select').value;
  renderEmailList();
}

// ════════════════════════════════════════════════════════
//  SYSTEM ALERTS
// ════════════════════════════════════════════════════════
function showSystemAlert() {
  const banner = document.getElementById('system-alert');
  if (DB.systemAlert) {
    document.getElementById('alert-text').textContent = DB.systemAlert;
    banner.classList.add('visible');
  } else {
    banner.classList.remove('visible');
  }
}

function broadcastAlert() {
  const txt = document.getElementById('alert-input').value.trim();
  if (!txt) return;
  DB.systemAlert = txt;
  saveData(DB);
  showSystemAlert();
  document.getElementById('alert-input').value = '';
}

function clearAlert() {
  DB.systemAlert = null;
  saveData(DB);
  showSystemAlert();
}

function dismissAlert() {
  document.getElementById('system-alert').classList.remove('visible');
}

// ════════════════════════════════════════════════════════
//  ADMIN PANEL
// ════════════════════════════════════════════════════════
function showAdminPanel(tab) {
  document.getElementById('admin-overlay').classList.add('visible');
  switchAdminTab(tab || 'accounts');
}

function closeAdminPanel() {
  document.getElementById('admin-overlay').classList.remove('visible');
}

function switchAdminTab(tabName) {
  document.querySelectorAll('.admin-tab').forEach(el => {
    el.classList.toggle('active', el.dataset.tab === tabName);
  });
  ['accounts','npcs','threads','alerts','audit'].forEach(t => {
    const el = document.getElementById(`admin-tab-${t}`);
    if (t === tabName) el.classList.remove('hidden');
    else el.classList.add('hidden');
  });

  if (tabName === 'accounts') renderAccountsTable();
  if (tabName === 'npcs') renderNpcList();
  if (tabName === 'threads') renderPrivateThreads();
  if (tabName === 'audit') renderAuditLog();
}

function renderAccountsTable() {
  const tbody = document.getElementById('accounts-table-body');
  tbody.innerHTML = '';
  DB.accounts.forEach(a => {
    const msgCount = DB.messages.filter(m => m.to.includes(a.handle)).length;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="handle">${escHtml(a.handle)}</td>
      <td class="${a.role === 'admin' ? 'role-admin' : ''}">${a.role}</td>
      <td>${msgCount}</td>
      <td class="actions">
        ${a.role !== 'admin' ? `<button class="btn-sm" onclick="viewAsGm('${a.handle}')">View Inbox</button>
        <button class="btn-sm red" onclick="removeAccount('${a.id}')">Remove</button>` : '—'}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function addAccount() {
  const name = document.getElementById('new-name').value.trim();
  const handle = document.getElementById('new-handle').value.trim();
  const username = document.getElementById('new-username').value.trim();
  const password = document.getElementById('new-password').value.trim();
  if (!name || !handle || !username || !password) { alert('All fields required.'); return; }

  DB.accounts.push({ id: username, username, name, handle, password, role: 'player' });
  saveData(DB);
  populateLoginDropdown();
  populateGmViewSelect();
  renderAccountsTable();

  ['new-name','new-handle','new-username','new-password'].forEach(id => {
    document.getElementById(id).value = '';
  });
}

function removeAccount(id) {
  if (!confirm('Remove this operative account?')) return;
  DB.accounts = DB.accounts.filter(a => a.id !== id);
  saveData(DB);
  renderAccountsTable();
  populateLoginDropdown();
  populateGmViewSelect();
}

function viewAsGm(handle) {
  document.getElementById('gm-view-select').value = handle;
  gmViewingUser = handle;
  closeAdminPanel();
  setFolder('inbox');
}

function renderNpcList() {
  const panel = document.getElementById('npc-list');
  panel.innerHTML = '';
  DB.npcs.forEach((n, i) => {
    const div = document.createElement('div');
    div.className = 'npc-item';
    div.innerHTML = `
      <span class="npc-name">${escHtml(n.name)}</span>
      <span class="npc-handle">${escHtml(n.handle)}</span>
      <button class="btn-sm red" onclick="removeNpc(${i})">Remove</button>
    `;
    panel.appendChild(div);
  });
}

function addNpc() {
  const name = document.getElementById('npc-name').value.trim();
  const handle = document.getElementById('npc-handle').value.trim();
  const sig = document.getElementById('npc-sig').value.trim();
  if (!name || !handle) { alert('Name and handle required.'); return; }
  DB.npcs.push({ id: `npc-${Date.now()}`, name, handle, sig });
  saveData(DB);
  renderNpcList();
  ['npc-name','npc-handle','npc-sig'].forEach(id => document.getElementById(id).value = '');
}

function removeNpc(i) {
  DB.npcs.splice(i, 1);
  saveData(DB);
  renderNpcList();
}

function renderPrivateThreads() {
  const panel = document.getElementById('thread-list-panel');
  panel.innerHTML = '';
  const privateMessages = DB.messages.filter(m => m.privateThread);

  if (!privateMessages.length) {
    panel.innerHTML = '<div style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);padding:16px 0;">No private threads found.</div>';
    return;
  }

  // Group by pair
  const groups = {};
  privateMessages.forEach(m => {
    const key = [m.from, ...m.to].sort().join('|');
    if (!groups[key]) groups[key] = [];
    groups[key].push(m);
  });

  Object.entries(groups).forEach(([key, msgs]) => {
    msgs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    const latest = msgs[0];
    const div = document.createElement('div');
    div.className = 'thread-item';
    div.innerHTML = `
      <div class="thread-players">${escHtml(key.replace(/\|/g, ' ↔ '))}</div>
      <div class="thread-last">${msgs.length} message${msgs.length>1?'s':''} — Last: ${escHtml(latest.subject)} at ${formatTime(latest.timestamp)}</div>
    `;
    div.onclick = () => {
      closeAdminPanel();
      openMessage(latest.id);
    };
    panel.appendChild(div);
  });
}

function renderAuditLog() {
  const panel = document.getElementById('audit-log-panel');
  panel.innerHTML = '';
  if (!DB.audit.length) {
    panel.innerHTML = '<div style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);">No audit entries.</div>';
    return;
  }
  DB.audit.slice(0, 100).forEach(e => {
    const div = document.createElement('div');
    div.className = 'audit-entry';
    div.innerHTML = `
      <span class="audit-time">${formatDateTime(e.time)}</span>
      <span><span class="from">${escHtml(e.from)}</span> → <span class="to">${escHtml(e.to)}</span>: ${escHtml(e.subject)}</span>
    `;
    panel.appendChild(div);
  });
}

// ════════════════════════════════════════════════════════
//  UTILITIES
// ════════════════════════════════════════════════════════
function getNpcName(handle) {
  const npc = DB.npcs.find(n => n.handle === handle);
  return npc ? npc.name : null;
}

function formatTime(iso) {
  const d = new Date(iso);
  const now = new Date();
  const diffH = (now - d) / 3600000;
  if (diffH < 24) return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString([], {month:'short',day:'numeric'});
}

function formatDateTime(iso) {
  const d = new Date(iso);
  return d.toLocaleString([], {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function stripHtml(html) {
  const tmp = document.createElement('div');
  tmp.innerHTML = html || '';
  return tmp.textContent || '';
}

// ════════════════════════════════════════════════════════
//  INIT  –  Firebase real-time bootstrap
//
//  We use GAME_REF.on('value', callback) rather than
//  GAME_REF.once('value', callback).
//
//  The difference:
//    .once()  → fires exactly one time (like a normal fetch)
//    .on()    → fires NOW with the current data, AND fires
//               again automatically whenever ANYONE changes
//               the database — the GM on their laptop, a
//               player on their phone, anyone.
//
//  So this single call does two jobs:
//    1. Initial load  – populates DB and shows the login
//       screen on first run.
//    2. Live updates  – keeps every player's screen in sync
//       without them ever pressing refresh.
// ════════════════════════════════════════════════════════

function initApp() {
  const statusEl = document.getElementById('loading-status-text');
  const loadingEl = document.getElementById('loading-screen');

  // ── Attach the real-time listener ───────────────────────
  GAME_REF.on('value', snapshot => {
    const incoming = snapshot.val();

    // FIRST LOAD: snapshot is null → database is empty →
    // write the default data so all future users share it.
    if (!incoming) {
      statusEl.textContent = 'INITIALIZING NEW SECURE NODE…';
      const defaults = getDefaultData();
      DB = defaults;
      saveData(DB);      // this will re-fire the listener with real data
      return;
    }

    // EVERY SUBSEQUENT CALL (both first load and live updates):
    const previousUser = currentUser ? currentUser.id : null;
    DB = incoming;       // update the global data object

    // Restore currentUser reference from the new DB snapshot
    // (the object identity changes on every update, so we
    //  must find the matching account by id each time)
    if (previousUser) {
      currentUser = DB.accounts.find(a => a.id === previousUser) || null;
    }

    // ── First load: hide the loading screen & show login ──
    if (loadingEl && !loadingEl.classList.contains('hidden')) {
      loadingEl.classList.add('fade-out');
      setTimeout(() => loadingEl.classList.add('hidden'), 500);
      populateLoginDropdown();
      document.getElementById('login-password').addEventListener('keydown', e => {
        if (e.key === 'Enter') attemptLogin();
      });
      return;   // don't try to re-render — no user is logged in yet
    }

    // ── Live update: a remote change arrived ─────────────
    // Suppress re-renders that we ourselves triggered via saveData()
    if (_isWriting) return;

    // Refresh the visible parts of the UI without disrupting
    // anything the current user has open (compose window, etc.)
    if (currentUser) {
      renderEmailList();           // update message counts & list
      updateUnreadBadge();         // update sidebar unread number
      showSystemAlert();           // show/hide the GM alert banner
      if (currentUser.role === 'admin') populateGmViewSelect();

      // If the currently-open message was updated remotely
      // (e.g. intercepted by GM), refresh its detail view too.
      if (selectedMessageId) {
        const stillExists = DB.messages.find(m => m.id === selectedMessageId);
        if (stillExists) openMessage(selectedMessageId);
        else {
          selectedMessageId = null;
          document.getElementById('detail-empty').classList.remove('hidden');
          document.getElementById('detail-view').classList.add('hidden');
        }
      }

      // Visual "new message" pulse on the inbox folder label
      flashNewMessage();
    }
  }, err => {
    // Connection error handler — shown if Firebase is unreachable
    // (e.g. wrong config, no internet, or security rules blocked us)
    console.error('[DG] Firebase connection error:', err);
    statusEl.textContent = 'CONNECTION FAILED — CHECK CONFIG';
    statusEl.style.color = 'var(--accent-red)';
  });
}

// Brief green flash on the Inbox nav item when new mail arrives
let _lastMessageCount = 0;
function flashNewMessage() {
  const count = DB.messages.filter(m =>
    currentUser && m.to.includes(currentUser.handle) && !m.read?.[currentUser.handle]
  ).length;
  if (count > _lastMessageCount) {
    const inboxEl = document.querySelector('[data-folder="inbox"]');
    if (inboxEl) {
      inboxEl.style.background = 'rgba(78,201,160,0.15)';
      setTimeout(() => { inboxEl.style.background = ''; }, 800);
    }
  }
  _lastMessageCount = count;
}

// Helper that the live-update handler calls to refresh the
// unread count badge in the sidebar without a full re-render
function updateUnreadBadge() {
  const badge = document.getElementById('unread-badge');
  if (!badge || !currentUser) return;
  const n = getUnreadCount();
  badge.textContent = n > 0 ? n : '';
  badge.style.display = n > 0 ? 'inline-flex' : 'none';
}

// ── Kick everything off ───────────────────────────────────
initApp();
</script>
</body>
</html>
